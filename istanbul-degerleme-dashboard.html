<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İST-DEĞER | İstanbul Değerleme Portal Pro v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        #main-map { 
            height: 650px; 
            border-radius: 1rem; 
            z-index: 1;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        
        .sidebar-scroll { 
            max-height: calc(100vh - 120px); 
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #3b82f6 #f1f5f9;
        }
        
        .sidebar-scroll::-webkit-scrollbar { width: 8px; }
        .sidebar-scroll::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
        
        .stat-card { 
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .stat-card:hover { 
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.3);
        }
        
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
        
        .marker-cluster {
            background-color: rgba(59, 130, 246, 0.6);
            border-radius: 50%;
            text-align: center;
            color: white;
            font-weight: bold;
        }
        
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .news-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        
        .news-item:hover {
            border-left-color: #3b82f6;
            background-color: #f8fafc;
            transform: translateX(4px);
        }
        
        .earthquake-item {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .data-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .map-control-btn {
            transition: all 0.2s ease;
        }
        
        .map-control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .live-indicator {
            width: 8px;
            height: 8px;
            background-color: #10b981;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 font-sans">

    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-slate-900 via-blue-900 to-slate-900 p-4 shadow-2xl sticky top-0 z-50 backdrop-blur-sm bg-opacity-95">
        <div class="container mx-auto flex flex-wrap items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="text-white">
                    <i class="fas fa-building text-3xl text-blue-400"></i>
                </div>
                <div>
                    <span class="font-bold text-2xl tracking-tight text-blue-400">İST<span class="text-white">-DEĞER</span></span>
                    <span class="ml-3 text-xs border border-blue-400 px-2 py-1 rounded-full text-blue-200">
                        <span class="live-indicator"></span>CANLI
                    </span>
                </div>
                <span class="hidden md:block text-xs border-l border-blue-700 pl-4 text-blue-200">
                    <i class="fas fa-chart-line mr-1"></i>
                    Emlak ve Değerleme Müdürlüğü | v3.0 Pro
                </span>
            </div>
            
            <div class="flex items-center space-x-6">
                <div id="live-clock" class="text-blue-200 font-mono text-sm hidden md:block">
                    <i class="far fa-clock mr-2"></i><span id="clock-time"></span>
                </div>
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition hidden md:block">
                    <i class="fas fa-download mr-2"></i>Rapor İndir
                </button>
            </div>
        </div>
    </nav>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" style="display: none;">
        <div class="bg-white rounded-xl p-8 flex flex-col items-center">
            <div class="loading-spinner mb-4"></div>
            <p class="text-gray-700 font-semibold">Veriler yükleniyor...</p>
        </div>
    </div>

    <div class="container mx-auto mt-6 px-4 pb-8">
        <div class="grid grid-cols-12 gap-6">
            
            <!-- Left Sidebar -->
            <div class="col-span-12 lg:col-span-3 space-y-6 sidebar-scroll">
                
                <!-- Economic Data -->
                <div class="bg-white rounded-2xl shadow-xl p-6 border-t-4 border-green-500 stat-card">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-chart-line text-green-500 text-xl"></i> 
                        <span>Ekonomik Göstergeler</span>
                        <span class="ml-auto text-xs text-gray-400" id="economy-update">Güncelleniyor...</span>
                    </h3>
                    <div class="space-y-3">
                        <div class="bg-gradient-to-r from-red-50 to-red-100 p-3 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700">USD/TRY</span>
                                <span id="usd-rate" class="font-bold text-red-600 text-lg">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                Değişim: <span id="usd-change" class="font-semibold">-</span>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-3 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700">EUR/TRY</span>
                                <span id="eur-rate" class="font-bold text-blue-600 text-lg">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                Değişim: <span id="eur-change" class="font-semibold">-</span>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 p-3 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700">Altın (Ons)</span>
                                <span id="gold-rate" class="font-bold text-yellow-600 text-lg">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-3 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-700">Konut Fiyat End.</span>
                                <span class="font-bold text-purple-600">%84.2</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Yıllık Değişim (2024)</div>
                        </div>
                    </div>
                </div>

                <!-- Earthquake Data -->
                <div class="bg-white rounded-2xl shadow-xl p-6 border-t-4 border-red-500 stat-card">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-house-damage text-red-500 text-xl"></i> 
                        <span>Son Depremler</span>
                        <span class="ml-auto">
                            <span class="data-badge bg-red-100 text-red-600" id="earthquake-count">0</span>
                        </span>
                    </h3>
                    <div id="earthquake-list" class="space-y-2 max-h-64 overflow-y-auto">
                        <div class="flex items-center justify-center py-8 text-gray-400">
                            <i class="fas fa-spinner fa-spin mr-2"></i> Yükleniyor...
                        </div>
                    </div>
                </div>

                <!-- Weather Widget -->
                <div class="gradient-bg text-white rounded-2xl shadow-xl p-6 stat-card">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm opacity-90 mb-1">
                                <i class="fas fa-map-marker-alt mr-1"></i>İstanbul
                            </p>
                            <h4 id="temp" class="text-5xl font-bold mb-2">
                                <i class="fas fa-spinner fa-spin"></i>
                            </h4>
                            <p id="weather-desc" class="text-sm opacity-80">Yükleniyor...</p>
                        </div>
                        <div class="text-right">
                            <i id="weather-icon" class="fas fa-cloud-sun text-5xl opacity-75"></i>
                            <p id="humidity" class="text-xs mt-2 opacity-80">-</p>
                        </div>
                    </div>
                    <div class="mt-6 pt-4 border-t border-white border-opacity-30">
                        <div class="grid grid-cols-2 gap-4 text-xs">
                            <div>
                                <p class="opacity-70">Rüzgar</p>
                                <p id="wind" class="font-semibold">-</p>
                            </div>
                            <div>
                                <p class="opacity-70">Basınç</p>
                                <p id="pressure" class="font-semibold">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-white border-opacity-30 text-xs">
                        <p id="prayer-time">
                            <i class="fas fa-mosque mr-2"></i>
                            Sıradaki Vakit: <span class="font-semibold">Yükleniyor...</span>
                        </p>
                    </div>
                </div>

                <!-- Traffic & City Stats -->
                <div class="bg-white rounded-2xl shadow-xl p-6 stat-card">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-city text-blue-500 text-xl"></i> 
                        <span>Şehir İstatistikleri</span>
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-2 bg-orange-50 rounded">
                            <span class="text-sm flex items-center gap-2">
                                <i class="fas fa-traffic-light text-orange-500"></i> Trafik Yoğunluğu
                            </span>
                            <span class="font-bold text-orange-600">%42</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-blue-50 rounded">
                            <span class="text-sm flex items-center gap-2">
                                <i class="fas fa-home text-blue-500"></i> Aktif İlan
                            </span>
                            <span class="font-bold text-blue-600">12.4k</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-green-50 rounded">
                            <span class="text-sm flex items-center gap-2">
                                <i class="fas fa-wind text-green-500"></i> Hava Kalitesi
                            </span>
                            <span class="font-bold text-green-600">İyi</span>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-purple-50 rounded">
                            <span class="text-sm flex items-center gap-2">
                                <i class="fas fa-bus text-purple-500"></i> Toplu Taşıma
                            </span>
                            <span class="font-bold text-purple-600">Normal</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center Map -->
            <div class="col-span-12 lg:col-span-6">
                <div class="bg-white rounded-2xl shadow-2xl p-4">
                    <!-- Map Controls -->
                    <div class="absolute top-8 right-8 z-[1000] flex flex-col gap-2">
                        <button onclick="loadLayer('ispark')" class="map-control-btn bg-white p-3 rounded-full shadow-lg hover:bg-blue-500 hover:text-white transition" title="İSPARK Otoparkları">
                            <i class="fas fa-parking"></i>
                        </button>
                        <button onclick="loadLayer('pharmacy')" class="map-control-btn bg-white p-3 rounded-full shadow-lg hover:bg-red-500 hover:text-white transition" title="Nöbetçi Eczaneler">
                            <i class="fas fa-pills"></i>
                        </button>
                        <button onclick="loadLayer('metro')" class="map-control-btn bg-white p-3 rounded-full shadow-lg hover:bg-green-500 hover:text-white transition" title="Metro İstasyonları">
                            <i class="fas fa-train"></i>
                        </button>
                        <button onclick="loadLayer('earthquake')" class="map-control-btn bg-white p-3 rounded-full shadow-lg hover:bg-orange-500 hover:text-white transition" title="Deprem Noktaları">
                            <i class="fas fa-house-damage"></i>
                        </button>
                        <button onclick="clearLayers()" class="map-control-btn bg-white p-3 rounded-full shadow-lg hover:bg-gray-500 hover:text-white transition" title="Katmanları Temizle">
                            <i class="fas fa-eraser"></i>
                        </button>
                    </div>
                    
                    <div id="main-map"></div>
                    
                    <!-- Map Info Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-6">
                        <div class="text-center p-3 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl hover:shadow-lg transition cursor-pointer">
                            <p class="text-[10px] text-gray-600 uppercase font-semibold mb-1">İBB Trafik</p>
                            <p class="font-bold text-orange-500 text-lg">%42</p>
                            <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                                <div class="bg-orange-500 h-1.5 rounded-full" style="width: 42%"></div>
                            </div>
                        </div>
                        <div class="text-center p-3 bg-gradient-to-br from-green-50 to-green-100 rounded-xl hover:shadow-lg transition cursor-pointer">
                            <p class="text-[10px] text-gray-600 uppercase font-semibold mb-1">Aktif İlan</p>
                            <p class="font-bold text-blue-600 text-lg">12.4k</p>
                            <p class="text-[9px] text-green-600 mt-1">
                                <i class="fas fa-arrow-up"></i> +5.2%
                            </p>
                        </div>
                        <div class="text-center p-3 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl hover:shadow-lg transition cursor-pointer">
                            <p class="text-[10px] text-gray-600 uppercase font-semibold mb-1">Hava Kalitesi</p>
                            <p class="font-bold text-green-500 text-lg">İyi</p>
                            <p class="text-[9px] text-gray-500 mt-1">AQI: 45</p>
                        </div>
                        <div class="text-center p-3 bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl hover:shadow-lg transition cursor-pointer">
                            <p class="text-[10px] text-gray-600 uppercase font-semibold mb-1">Toplu Taşıma</p>
                            <p class="font-bold text-blue-800 text-lg">Normal</p>
                            <p class="text-[9px] text-gray-500 mt-1">İETT Aktif</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="col-span-12 lg:col-span-3 space-y-6">
                
                <!-- News Feed -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h3 class="font-bold text-gray-800 mb-4 border-b pb-3 flex items-center gap-2">
                        <i class="fas fa-newspaper text-blue-500"></i>
                        <span>Haber Akışı</span>
                        <span class="ml-auto text-xs text-gray-400">Canlı</span>
                    </h3>
                    <div id="news-feed" class="space-y-3">
                        <div class="flex items-center justify-center py-8 text-gray-400">
                            <i class="fas fa-spinner fa-spin mr-2"></i> Haberler yükleniyor...
                        </div>
                    </div>
                </div>

                <!-- District Value Analysis Chart -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h3 class="font-bold text-gray-800 mb-4 border-b pb-3 flex items-center gap-2">
                        <i class="fas fa-chart-bar text-green-500"></i>
                        <span>İlçe Değer Analizi</span>
                    </h3>
                    <canvas id="districtChart" height="220"></canvas>
                    <div class="mt-4 text-xs text-gray-500 text-center">
                        <i class="fas fa-info-circle mr-1"></i>
                        m² başına ortalama satış fiyatı (bin ₺)
                    </div>
                </div>

                <!-- Property Price Trend -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h3 class="font-bold text-gray-800 mb-4 border-b pb-3 flex items-center gap-2">
                        <i class="fas fa-chart-line text-purple-500"></i>
                        <span>Fiyat Trendi (6 Ay)</span>
                    </h3>
                    <canvas id="trendChart" height="180"></canvas>
                </div>

                <!-- Quick Query -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 text-white rounded-2xl shadow-xl p-6">
                    <h3 class="text-sm font-bold mb-4 uppercase tracking-widest flex items-center gap-2">
                        <i class="fas fa-search"></i>
                        <span>Hızlı Sorgu</span>
                    </h3>
                    <input 
                        type="text" 
                        id="quick-search"
                        placeholder="Ada, parsel veya adres no..." 
                        class="w-full bg-slate-700 border-none rounded-lg p-3 text-sm focus:ring-2 ring-blue-500 outline-none transition"
                    >
                    <button 
                        onclick="performQuickSearch()"
                        class="w-full mt-3 bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-bold transition text-sm shadow-lg hover:shadow-xl"
                    >
                        <i class="fas fa-search mr-2"></i>Sorgula
                    </button>
                    <div class="mt-4 pt-4 border-t border-slate-700">
                        <p class="text-xs text-slate-400 mb-2">Hızlı Erişim:</p>
                        <div class="flex flex-wrap gap-2">
                            <button class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-full transition">
                                <i class="fas fa-building mr-1"></i>Kadıköy
                            </button>
                            <button class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-full transition">
                                <i class="fas fa-building mr-1"></i>Beşiktaş
                            </button>
                            <button class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-full transition">
                                <i class="fas fa-building mr-1"></i>Şişli
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Status -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h3 class="font-bold text-gray-800 mb-4 border-b pb-3 flex items-center gap-2">
                        <i class="fas fa-server text-green-500"></i>
                        <span>Sistem Durumu</span>
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">
                                <i class="fas fa-database mr-2 text-green-500"></i>Veritabanı
                            </span>
                            <span class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full font-semibold">
                                <i class="fas fa-check-circle mr-1"></i>Aktif
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">
                                <i class="fas fa-cloud mr-2 text-blue-500"></i>API Servisleri
                            </span>
                            <span class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-semibold">
                                <i class="fas fa-sync fa-spin mr-1"></i>Canlı
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">
                                <i class="fas fa-map mr-2 text-purple-500"></i>Harita Modülü
                            </span>
                            <span class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full font-semibold">
                                <i class="fas fa-check-circle mr-1"></i>Hazır
                            </span>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500">
                            <i class="fas fa-clock mr-1"></i>
                            Son Güncelleme: <span id="last-update" class="font-semibold">-</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-slate-900 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sm text-gray-400">
                <i class="fas fa-shield-alt mr-2"></i>
                © 2025 İstanbul Büyükşehir Belediyesi - Emlak ve Değerleme Müdürlüğü
            </p>
            <p class="text-xs text-gray-500 mt-2">
                Veriler: İBB Açık Veri, TCMB EVDS, Kandilli Rasathanesi, OpenWeatherMap, CollectAPI
            </p>
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let map;
        let markersLayer = L.layerGroup();
        let earthquakeMarkers = [];
        
        // ============================================
        // INITIALIZE MAP
        // ============================================
        function initMap() {
            map = L.map('main-map').setView([41.0082, 28.9784], 11);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap contributors © CARTO | İST-DEĞER v3.0',
                maxZoom: 19
            }).addTo(map);
            
            markersLayer.addTo(map);
            
            // Add scale
            L.control.scale({imperial: false, metric: true}).addTo(map);
        }

        // ============================================
        // LIVE CLOCK
        // ============================================
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('tr-TR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const dateStr = now.toLocaleDateString('tr-TR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('clock-time').innerHTML = `${timeStr}<br><small class="text-xs opacity-75">${dateStr}</small>`;
        }

        // ============================================
        // TCMB EXCHANGE RATES (EVDS API Alternative)
        // ============================================
        async function fetchExchangeRates() {
            try {
                // Using CollectAPI for exchange rates (free tier)
                // You would need to register at collectapi.com to get API key
                // For demo purposes, using mock data
                
                const mockRates = {
                    USD: 34.82,
                    EUR: 37.15,
                    GBP: 43.28,
                    GOLD: 92450
                };
                
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Update USD
                document.getElementById('usd-rate').innerHTML = `${mockRates.USD.toFixed(2)} ₺`;
                document.getElementById('usd-change').innerHTML = '<i class="fas fa-arrow-up"></i> +0.15%';
                document.getElementById('usd-change').className = 'font-semibold text-green-600';
                
                // Update EUR
                document.getElementById('eur-rate').innerHTML = `${mockRates.EUR.toFixed(2)} ₺`;
                document.getElementById('eur-change').innerHTML = '<i class="fas fa-arrow-down"></i> -0.08%';
                document.getElementById('eur-change').className = 'font-semibold text-red-600';
                
                // Update Gold
                document.getElementById('gold-rate').innerHTML = `${mockRates.GOLD.toLocaleString('tr-TR')} ₺`;
                
                // Update timestamp
                const now = new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
                document.getElementById('economy-update').textContent = now;
                
            } catch (error) {
                console.error('Exchange rates error:', error);
                document.getElementById('usd-rate').textContent = 'Hata';
                document.getElementById('eur-rate').textContent = 'Hata';
            }
        }

        // ============================================
        // EARTHQUAKE DATA (Kandilli)
        // ============================================
        async function fetchEarthquakes() {
            try {
                // Using AFAD/Kandilli earthquake data
                // For demo, using mock data - in production use actual API
                const mockEarthquakes = [
                    {location: 'Marmara Denizi', magnitude: 3.2, depth: 7.8, time: '2 saat önce', lat: 40.7, lon: 29.1},
                    {location: 'Silivri Açıkları', magnitude: 2.8, depth: 12.4, time: '4 saat önce', lat: 41.0, lon: 28.2},
                    {location: 'Yalova', magnitude: 2.4, depth: 8.2, time: '6 saat önce', lat: 40.65, lon: 29.27},
                    {location: 'Çanakkale', magnitude: 3.5, depth: 15.1, time: '8 saat önce', lat: 40.15, lon: 26.41},
                    {location: 'Bursa', magnitude: 2.1, depth: 5.6, time: '10 saat önce', lat: 40.18, lon: 29.06}
                ];
                
                const listHTML = mockEarthquakes.map((eq, index) => {
                    const color = eq.magnitude >= 3 ? 'red' : eq.magnitude >= 2.5 ? 'orange' : 'yellow';
                    return `
                        <div class="earthquake-item p-3 bg-${color}-50 rounded-lg border-l-4 border-${color}-500" style="animation-delay: ${index * 0.1}s">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="font-bold text-${color}-700 text-lg">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>${eq.magnitude} ML
                                    </div>
                                    <div class="text-sm text-gray-700 font-medium mt-1">${eq.location}</div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        <i class="fas fa-arrows-alt-v mr-1"></i>Derinlik: ${eq.depth} km
                                    </div>
                                </div>
                                <div class="text-right text-xs text-gray-400">
                                    <i class="far fa-clock mr-1"></i>${eq.time}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('earthquake-list').innerHTML = listHTML;
                document.getElementById('earthquake-count').textContent = mockEarthquakes.length;
                
                // Store for map layer
                earthquakeMarkers = mockEarthquakes;
                
            } catch (error) {
                console.error('Earthquake data error:', error);
                document.getElementById('earthquake-list').innerHTML = `
                    <div class="text-center py-4 text-red-500">
                        <i class="fas fa-exclamation-circle mr-2"></i>Veri alınamadı
                    </div>
                `;
            }
        }

        // ============================================
        // WEATHER DATA
        // ============================================
        async function fetchWeather() {
            try {
                // Using OpenWeatherMap API (free tier)
                // Get your API key from openweathermap.org
                const API_KEY = 'DEMO_KEY'; // Replace with actual key
                
                // Mock data for demo
                const mockWeather = {
                    temp: 14,
                    description: 'Parçalı Bulutlu',
                    humidity: 65,
                    wind: '12 km/s KB',
                    pressure: '1013 hPa',
                    icon: 'cloud-sun'
                };
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                document.getElementById('temp').innerHTML = `${mockWeather.temp}°C`;
                document.getElementById('weather-desc').textContent = mockWeather.description;
                document.getElementById('humidity').innerHTML = `<i class="fas fa-tint mr-1"></i>Nem: ${mockWeather.humidity}%`;
                document.getElementById('wind').textContent = mockWeather.wind;
                document.getElementById('pressure').textContent = mockWeather.pressure;
                document.getElementById('weather-icon').className = `fas fa-${mockWeather.icon} text-5xl opacity-75`;
                
            } catch (error) {
                console.error('Weather error:', error);
                document.getElementById('temp').textContent = 'Hata';
            }
        }

        // ============================================
        // PRAYER TIMES
        // ============================================
        async function fetchPrayerTimes() {
            try {
                // Mock prayer times data
                const mockPrayer = {
                    next: 'İkindi',
                    time: '15:42'
                };
                
                document.getElementById('prayer-time').innerHTML = `
                    <i class="fas fa-mosque mr-2"></i>
                    Sıradaki Vakit: <span class="font-semibold">${mockPrayer.next} (${mockPrayer.time})</span>
                `;
                
            } catch (error) {
                console.error('Prayer times error:', error);
            }
        }

        // ============================================
        // NEWS FEED
        // ============================================
        async function fetchNews() {
            try {
                // Mock news data
                const mockNews = [
                    {category: 'EKONOMİ', title: 'İstanbul\'da konut satışları %15 arttı', color: 'blue'},
                    {category: 'ULAŞIM', title: 'Yeni metro hattı emlak değerlerini uçurdu', color: 'red'},
                    {category: 'İMAR', title: 'Kadıköy\'de yeni imar planı onaylandı', color: 'green'},
                    {category: 'PROJE', title: 'Kanal İstanbul çevresinde değer artışı', color: 'purple'},
                    {category: 'ANALİZ', title: 'Yabancı yatırımcı ilgisi rekor seviyede', color: 'orange'}
                ];
                
                const newsHTML = mockNews.map(news => `
                    <div class="news-item group cursor-pointer p-3 rounded-lg">
                        <p class="text-xs text-${news.color}-500 font-bold mb-1">
                            <i class="fas fa-circle text-[6px] mr-1"></i>${news.category}
                        </p>
                        <h5 class="text-sm font-medium text-gray-700 group-hover:text-blue-600 transition">
                            ${news.title}
                        </h5>
                        <p class="text-xs text-gray-400 mt-1">
                            <i class="far fa-clock mr-1"></i>${Math.floor(Math.random() * 5) + 1} saat önce
                        </p>
                    </div>
                `).join('');
                
                document.getElementById('news-feed').innerHTML = newsHTML;
                
            } catch (error) {
                console.error('News error:', error);
            }
        }

        // ============================================
        // MAP LAYERS
        // ============================================
        async function loadLayer(type) {
            const loading = document.getElementById('loading-overlay');
            loading.style.display = 'flex';
            
            try {
                markersLayer.clearLayers();
                
                if (type === 'ispark') {
                    // İSPARK parking data from İBB Open Data
                    const mockParking = [
                        {name: 'Kadıköy İSPARK', lat: 40.9833, lon: 29.0333, capacity: 150, available: 45},
                        {name: 'Beşiktaş İSPARK', lat: 41.0425, lon: 29.0058, capacity: 200, available: 78},
                        {name: 'Şişli İSPARK', lat: 41.0602, lon: 28.9887, capacity: 180, available: 92},
                        {name: 'Bakırköy İSPARK', lat: 40.9833, lon: 28.8667, capacity: 220, available: 134}
                    ];
                    
                    mockParking.forEach(park => {
                        const availabilityPercent = (park.available / park.capacity * 100).toFixed(0);
                        const color = availabilityPercent > 50 ? 'green' : availabilityPercent > 25 ? 'orange' : 'red';
                        
                        const marker = L.marker([park.lat, park.lon], {
                            icon: L.divIcon({
                                className: 'custom-icon',
                                html: `<div style="background-color: ${color}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
                                    <i class="fas fa-parking"></i>
                                </div>`,
                                iconSize: [30, 30]
                            })
                        });
                        
                        marker.bindPopup(`
                            <div class="p-2">
                                <h3 class="font-bold text-sm mb-2">${park.name}</h3>
                                <div class="text-xs space-y-1">
                                    <p><i class="fas fa-car mr-1"></i>Kapasite: ${park.capacity}</p>
                                    <p><i class="fas fa-check-circle mr-1 text-${color}-500"></i>Boş: ${park.available} (%${availabilityPercent})</p>
                                </div>
                            </div>
                        `);
                        
                        markersLayer.addLayer(marker);
                    });
                    
                } else if (type === 'pharmacy') {
                    // Pharmacy data from CollectAPI
                    const mockPharmacies = [
                        {name: 'Eczane Kadıköy', lat: 40.9833, lon: 29.0333, address: 'Kadıköy Merkez'},
                        {name: 'Eczane Beşiktaş', lat: 41.0425, lon: 29.0058, address: 'Beşiktaş Çarşı'},
                        {name: 'Eczane Şişli', lat: 41.0602, lon: 28.9887, address: 'Şişli Merkez'}
                    ];
                    
                    mockPharmacies.forEach(pharmacy => {
                        const marker = L.marker([pharmacy.lat, pharmacy.lon], {
                            icon: L.divIcon({
                                className: 'custom-icon',
                                html: `<div style="background-color: #ef4444; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
                                    <i class="fas fa-pills"></i>
                                </div>`,
                                iconSize: [30, 30]
                            })
                        });
                        
                        marker.bindPopup(`
                            <div class="p-2">
                                <h3 class="font-bold text-sm mb-2"><i class="fas fa-pills text-red-500 mr-1"></i>${pharmacy.name}</h3>
                                <p class="text-xs"><i class="fas fa-map-marker-alt mr-1"></i>${pharmacy.address}</p>
                                <p class="text-xs mt-1"><i class="fas fa-clock mr-1"></i>Nöbetçi: 24 Saat</p>
                            </div>
                        `);
                        
                        markersLayer.addLayer(marker);
                    });
                    
                } else if (type === 'metro') {
                    // Metro stations from İBB
                    const mockMetro = [
                        {name: 'Kadıköy Metro', lat: 40.9833, lon: 29.0333, line: 'M4'},
                        {name: 'Beşiktaş Metro', lat: 41.0425, lon: 29.0058, line: 'M7'},
                        {name: 'Şişli Metro', lat: 41.0602, lon: 28.9887, line: 'M2'}
                    ];
                    
                    mockMetro.forEach(station => {
                        const marker = L.marker([station.lat, station.lon], {
                            icon: L.divIcon({
                                className: 'custom-icon',
                                html: `<div style="background-color: #10b981; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
                                    <i class="fas fa-train"></i>
                                </div>`,
                                iconSize: [30, 30]
                            })
                        });
                        
                        marker.bindPopup(`
                            <div class="p-2">
                                <h3 class="font-bold text-sm mb-2"><i class="fas fa-train text-green-500 mr-1"></i>${station.name}</h3>
                                <p class="text-xs"><i class="fas fa-route mr-1"></i>Hat: ${station.line}</p>
                            </div>
                        `);
                        
                        markersLayer.addLayer(marker);
                    });
                    
                } else if (type === 'earthquake') {
                    // Earthquake markers
                    earthquakeMarkers.forEach(eq => {
                        const color = eq.magnitude >= 3 ? '#ef4444' : eq.magnitude >= 2.5 ? '#f59e0b' : '#eab308';
                        
                        const marker = L.circle([eq.lat, eq.lon], {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.3,
                            radius: eq.magnitude * 5000
                        });
                        
                        marker.bindPopup(`
                            <div class="p-2">
                                <h3 class="font-bold text-sm mb-2"><i class="fas fa-house-damage text-red-500 mr-1"></i>Deprem</h3>
                                <div class="text-xs space-y-1">
                                    <p><i class="fas fa-chart-line mr-1"></i>Büyüklük: ${eq.magnitude} ML</p>
                                    <p><i class="fas fa-map-marker-alt mr-1"></i>${eq.location}</p>
                                    <p><i class="fas fa-arrows-alt-v mr-1"></i>Derinlik: ${eq.depth} km</p>
                                    <p><i class="far fa-clock mr-1"></i>${eq.time}</p>
                                </div>
                            </div>
                        `);
                        
                        markersLayer.addLayer(marker);
                    });
                }
                
                setTimeout(() => {
                    loading.style.display = 'none';
                }, 500);
                
            } catch (error) {
                console.error('Layer loading error:', error);
                loading.style.display = 'none';
                alert('Katman yüklenirken hata oluştu');
            }
        }

        function clearLayers() {
            markersLayer.clearLayers();
        }

        // ============================================
        // CHARTS
        // ============================================
        function initCharts() {
            // District Chart
            const ctxDistrict = document.getElementById('districtChart').getContext('2d');
            new Chart(ctxDistrict, {
                type: 'bar',
                data: {
                    labels: ['Kadıköy', 'Beşiktaş', 'Şişli', 'Sarıyer', 'Bakırköy', 'Üsküdar'],
                    datasets: [{
                        label: 'm² Fiyatı (bin ₺)',
                        data: [85, 92, 110, 145, 78, 95],
                        backgroundColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444',
                            '#8b5cf6',
                            '#06b6d4'
                        ],
                        borderRadius: 8,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14 },
                            bodyFont: { size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // Trend Chart
            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: ['Ağu', 'Eyl', 'Eki', 'Kas', 'Ara', 'Oca'],
                    datasets: [{
                        label: 'Ortalama Fiyat',
                        data: [75, 78, 82, 88, 93, 98],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 5,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // ============================================
        // QUICK SEARCH
        // ============================================
        function performQuickSearch() {
            const searchValue = document.getElementById('quick-search').value;
            if (!searchValue.trim()) {
                alert('Lütfen bir arama terimi girin');
                return;
            }
            
            const loading = document.getElementById('loading-overlay');
            loading.style.display = 'flex';
            
            setTimeout(() => {
                loading.style.display = 'none';
                alert(`"${searchValue}" için arama tamamlandı.\n\nBu özellik geliştirme aşamasındadır.`);
            }, 1000);
        }

        // Allow search on Enter key
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('quick-search');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performQuickSearch();
                    }
                });
            }
        });

        // ============================================
        // UPDATE LAST UPDATE TIME
        // ============================================
        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('tr-TR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('last-update').textContent = timeStr;
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        async function init() {
            console.log('🚀 İST-DEĞER Dashboard v3.0 başlatılıyor...');
            
            // Initialize map
            initMap();
            
            // Initialize charts
            initCharts();
            
            // Start clock
            updateClock();
            setInterval(updateClock, 1000);
            
            // Fetch all data
            await Promise.all([
                fetchExchangeRates(),
                fetchEarthquakes(),
                fetchWeather(),
                fetchPrayerTimes(),
                fetchNews()
            ]);
            
            // Update timestamps
            updateLastUpdateTime();
            
            // Refresh data periodically
            setInterval(fetchExchangeRates, 60000); // Every minute
            setInterval(fetchEarthquakes, 300000); // Every 5 minutes
            setInterval(fetchWeather, 600000); // Every 10 minutes
            setInterval(fetchNews, 900000); // Every 15 minutes
            setInterval(updateLastUpdateTime, 60000); // Every minute
            
            console.log('✅ Dashboard hazır!');
        }

        // Start when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>